name: Publish Homebrew Formula

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate formula from release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ github.event.inputs.version }}"
          
          # Validate version format
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$ ]]; then
            echo "❌ Invalid version format: $VERSION"
            exit 1
          fi
          
          echo "📥 Downloading checksums for $VERSION..."
          mkdir -p checksums && cd checksums
          
          # Download checksum files for Homebrew platforms
          for platform in linux-amd64 linux-arm64 darwin-amd64 darwin-arm64; do
            gh release download "$VERSION" --pattern "jfcm-${VERSION}-${platform}.tar.gz.sha256"
          done
          
          # Generate formula
          ../.github/scripts/generate-homebrew-formula.sh \
            "$VERSION" \
            "${{ github.repository }}" \
            "$(awk '{print $1}' jfcm-${VERSION}-darwin-amd64.tar.gz.sha256)" \
            "$(awk '{print $1}' jfcm-${VERSION}-darwin-arm64.tar.gz.sha256)" \
            "$(awk '{print $1}' jfcm-${VERSION}-linux-amd64.tar.gz.sha256)" \
            "$(awk '{print $1}' jfcm-${VERSION}-linux-arm64.tar.gz.sha256)"

      - name: Publish to tap
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          if [[ -z "$HOMEBREW_TAP_TOKEN" ]]; then
            echo "❌ HOMEBREW_TAP_TOKEN not configured"
            exit 1
          fi
          
          VERSION="${{ github.event.inputs.version }}"
          
          # Clone and update tap
          git clone "https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/jfrog/homebrew-jfrog-cli-manager.git" tap
          cd tap
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          mkdir -p Formula
          cp ../checksums/jfcm.rb Formula/jfcm.rb
          
          if ! git diff --quiet HEAD Formula/jfcm.rb 2>/dev/null; then
            git add Formula/jfcm.rb
            git commit -m "Update jfcm to $VERSION"
            git push origin main
            echo "✅ Published $VERSION to Homebrew tap"
          else
            echo "✅ Formula already up to date"
          fi